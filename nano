// app/api/health/route.js
import { NextResponse } from "next/server";
import { Redis } from "@upstash/redis";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

const redis = Redis.fromEnv();
const PAYLOAD_KEY = "assets_payload";

function now() {
  return Date.now();
}

function json(payload, status = 200) {
  const res = NextResponse.json(payload, { status });

  res.headers.set("cache-control", "no-store");
  res.headers.set("access-control-allow-origin", "*");

  return res;
}

export async function GET() {
  const start = now();

  try {
    const payload = await redis.get(PAYLOAD_KEY);

    const latency = now() - start;

    if (!payload) {
      return json({
        ok: false,
        ts: now(),
        service: "zilkara-scan",
        redis: true,
        scan: false,
        latency_ms: latency,
        asset_count: 0,
        last_update: null,
        status: "NO_DATA",
      }, 503);
    }

    const assets =
      payload.assets || payload.data || [];

    const updatedAt =
      payload.payload_updatedAt ||
      payload.updatedAt ||
      null;

    const age_sec = updatedAt
      ? Math.floor((now() - updatedAt) / 1000)
      : null;

    const healthy =
      Array.isArray(assets) &&
      assets.length > 0 &&
      latency < 2000;

    const result = {
      ok: healthy,
      ts: now(),

      service: "zilkara-scan",

      redis: true,
      scan: true,

      latency_ms: latency,

      asset_count: assets.length,

      last_update: updatedAt,
      age_sec,

      status: healthy ? "OK" : "DEGRADED",
    };

    console.log(JSON.stringify({
      route: "/api/health",
      event: "health_check",
      latency_ms: latency,
      asset_count: assets.length,
      healthy,
    }));

    return json(result, healthy ? 200 : 503);

  } catch (e) {

    console.error(JSON.stringify({
      route: "/api/health",
      event: "health_error",
      error: e.message,
    }));

    return json({
      ok: false,
      ts: now(),
      service: "zilkara-scan",
      redis: false,
      scan: false,
      latency_ms: null,
      asset_count: 0,
      last_update: null,
      status: "ERROR",
      error: e.message,
    }, 500);
  }
}
