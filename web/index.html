<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>Zilkara — Market Scanner</title>
  <style>
    :root{
      --bg:#070c14;
      --panel: rgba(22,33,54,.55);
      --panel2: rgba(22,33,54,.38);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.45);
      --btn: rgba(255,255,255,.10);
      --btn2: rgba(255,255,255,.16);
      --accent: rgba(83,130,255,.85);
      --good: rgba(48,201,116,.22);
      --warn: rgba(255,185,66,.20);
      --bad: rgba(255,88,88,.20);
      --chip: rgba(255,255,255,.09);
      --shadow: 0 14px 46px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 16px;
      --gap: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 900px at 30% -10%, rgba(83,130,255,.18), transparent 60%),
        radial-gradient(900px 700px at 70% 10%, rgba(0,255,160,.10), transparent 62%),
        radial-gradient(900px 700px at 50% 120%, rgba(83,130,255,.10), transparent 62%),
        linear-gradient(180deg, #060b12 0%, #050916 100%);
      color: var(--text);
      padding: 18px 14px 32px;
      padding-top: max(18px, env(safe-area-inset-top));
      padding-bottom: max(32px, env(safe-area-inset-bottom));
    }

    .container{ max-width: 980px; margin:0 auto; }

    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: 14px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(16px 16px at 25% 25%, rgba(255,255,255,.20), transparent 60%),
        linear-gradient(135deg, rgba(83,130,255,.95), rgba(0,255,160,.65));
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.16);
      flex:0 0 auto;
    }
    h1{
      margin:0;
      font-size: 34px;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .subtitle{
      margin-top: 2px;
      color: var(--muted);
      font-size: 14px;
    }

    .chips{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 4px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--chip);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background: rgba(255,255,255,.25);
      border: 1px solid rgba(255,255,255,.18);
    }
    .dot.ok{ background: rgba(48,201,116,.85); border-color: rgba(48,201,116,.35); }

    .panel{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
    }

    .metaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .metaText{
      color: var(--muted);
      font-size: 14px;
    }
    .metaText strong{ color: var(--text); font-weight: 700; }
    .metaSmall{ color: var(--muted2); font-size: 13px; margin-top: 4px; }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: var(--btn);
      color: var(--text);
      font-size: 15px;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn:hover{ background: var(--btn2); border-color: var(--stroke2); }

    .btn.primary{
      background: rgba(83,130,255,.28);
      border-color: rgba(83,130,255,.40);
    }
    .btn.primary:hover{
      background: rgba(83,130,255,.34);
      border-color: rgba(83,130,255,.52);
    }

    .btn .ico{
      width:18px;height:18px; display:inline-block;
      opacity:.9;
    }
    .ico svg{ width:18px;height:18px; display:block; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .filters{
      background: var(--panel2);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: 0 10px 34px rgba(0,0,0,.40);
      padding: 14px;
    }

    .filterGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .field label{
      display:block;
      font-size: 13px;
      color: var(--muted2);
      margin: 2px 0 8px;
      padding-left: 2px;
    }
    input[type="text"], select{
      width:100%;
      appearance:none;
      -webkit-appearance:none;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 14px 14px;
      font-size: 16px;
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    select{
      padding-right: 40px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.65) 50%),
        linear-gradient(135deg, rgba(255,255,255,.65) 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) 22px,
        calc(100% - 12px) 22px,
        calc(100% - 2.6em) 0.5em;
      background-size: 6px 6px, 6px 6px, 1px 1.8em;
      background-repeat: no-repeat;
    }

    .hint{
      margin-top: 12px;
      color: var(--muted2);
      font-size: 13px;
    }
    .aff{
      margin-top: 8px;
      color: var(--muted2);
      font-size: 14px;
      font-family: var(--mono);
    }

    .list{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 2px;
    }

    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      overflow:hidden;
    }

    .cardTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom: 12px;
    }
    .cardTitle{
      display:flex; align-items:baseline; gap:8px; flex-wrap:wrap;
      min-width: 0;
    }
    .star{
      width:22px;height:22px; display:inline-flex; align-items:center; justify-content:center;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      flex:0 0 auto;
    }
    .star svg{ width:14px;height:14px; opacity:.75; }
    .star.on{ border-color: rgba(83,130,255,.45); background: rgba(83,130,255,.12); }
    .star.on svg{ opacity: 1; }

    .sym{
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .4px;
      white-space:nowrap;
    }
    .rank{
      font-size: 14px;
      color: var(--muted2);
      font-family: var(--mono);
    }
    .name{
      font-size: 13px;
      color: var(--muted);
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space:nowrap;
    }

    .badge{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight: 700;
      letter-spacing: .3px;
      font-size: 13px;
      white-space:nowrap;
      height: fit-content;
    }
    .badge.strong{ background: rgba(48,201,116,.20); border-color: rgba(48,201,116,.28); }
    .badge.good{ background: rgba(83,130,255,.18); border-color: rgba(83,130,255,.28); }
    .badge.weak{ background: rgba(255,185,66,.18); border-color: rgba(255,185,66,.26); }
    .badge.avoid{ background: rgba(255,88,88,.16); border-color: rgba(255,88,88,.24); }

    .metrics{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    .box{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      padding: 10px 12px;
    }
    .box .k{
      font-size: 12px;
      color: var(--muted2);
      letter-spacing: .4px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .box .v{
      font-size: 18px;
      font-weight: 800;
    }
    .box .v.mono{ font-family: var(--mono); font-size: 16px; }

    .changes{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    .chg{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      padding: 10px 12px;
      text-align:left;
    }
    .chg .k{ font-size: 12px; color: var(--muted2); text-transform: uppercase; margin-bottom: 6px; }
    .chg .v{ font-size: 16px; font-weight: 800; font-family: var(--mono); }
    .pos{ color: rgba(48,201,116,.95); }
    .neg{ color: rgba(255,110,110,.95); }
    .neu{ color: rgba(255,255,255,.78); }

    .rowBtns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .btnRow{
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size: 15px;
      font-weight: 700;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btnRow.primary{
      background: rgba(83,130,255,.26);
      border-color: rgba(83,130,255,.38);
    }

    .footerLine{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 13px;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
    }

    @media (min-width: 860px){
      body{ padding: 22px; padding-top: max(22px, env(safe-area-inset-top)); }
      .grid{ grid-template-columns: 420px 1fr; align-items:start; }
      .filterGrid{ grid-template-columns: 1fr 1fr; }
      .field.span2{ grid-column: 1 / span 2; }
      .list{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Zilkara</h1>
          <div class="subtitle">Market Scanner</div>
        </div>
      </div>

      <div class="chips">
        <div class="chip" id="chipMvp">
          <span class="dot"></span>
          <span>MVP</span>
        </div>
        <div class="chip" id="chipApi">
          <span class="dot ok"></span>
          <span id="apiStamp">API —</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: controls -->
      <div class="panel">
        <div class="metaRow">
          <div>
            <div class="metaText">
              <strong id="assetsCount">0</strong> assets loaded
            </div>
            <div class="metaSmall" id="cacheLine">Cache navigateur : désactivé</div>
          </div>

          <div class="actions">
            <a class="btn primary" id="openBinance" href="#" target="_blank" rel="noopener">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 17L17 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M10 7h7v7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              Ouvrir Binance
            </a>

            <button class="btn" id="refreshBtn" type="button">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              Refresh
            </button>

            <button class="btn" id="exportBtn" type="button">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M8 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M4 17v3h16v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              Export CSV
            </button>
          </div>
        </div>

        <div class="filters">
          <div class="filterGrid">
            <div class="field span2">
              <label for="search">Search</label>
              <input id="search" type="text" inputmode="search" placeholder="Search (BTC, ETH...)" autocomplete="off" />
            </div>

            <div class="field">
              <label for="sort">Sort</label>
              <select id="sort">
                <option value="score_desc" selected>Score Desc</option>
                <option value="score_asc">Score Asc</option>
                <option value="rank_asc">Rank Asc</option>
                <option value="rank_desc">Rank Desc</option>
                <option value="price_desc">Price Desc</option>
                <option value="price_asc">Price Asc</option>
                <option value="chg24_desc">24h Desc</option>
                <option value="chg24_asc">24h Asc</option>
              </select>
            </div>

            <div class="field">
              <label for="rating">Rating</label>
              <select id="rating">
                <option value="all" selected>All</option>
                <option value="STRONG">STRONG</option>
                <option value="GOOD">GOOD</option>
                <option value="WEAK">WEAK</option>
                <option value="AVOID">AVOID</option>
              </select>
            </div>

            <div class="field">
              <label for="vs">VS</label>
              <select id="vs">
                <option value="eur" selected>EUR</option>
                <option value="usd">USD</option>
              </select>
            </div>

            <div class="field">
              <label for="limit">Limit</label>
              <select id="limit">
                <option value="50">Top 50</option>
                <option value="100">Top 100</option>
                <option value="250" selected>Top 250</option>
              </select>
            </div>

            <div class="field span2">
              <label for="mode">Mode</label>
              <select id="mode">
                <option value="all" selected>All assets</option>
                <option value="favorites">Favorites</option>
              </select>
            </div>
          </div>

          <div class="hint">
            Tip: <span style="font-family:var(--mono)">Cmd + Shift + R</span> pour vider le cache
          </div>
          <div class="aff" id="affLine">Affiliation Binance: 1216069378</div>
        </div>

        <div class="footerLine">
          <div id="sourceStamp">Source: CoinGecko • VS: EUR</div>
          <div id="miniStatus">—</div>
        </div>
      </div>

      <!-- RIGHT: list -->
      <div>
        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

    <div id="results"></div>

<script type="module" src="./app.js"></script>

  <script>
    // ============================
    // CONFIG
    // ============================
    const AFF_ID = "1216069378";
    const API_BASE = ""; // same host
    const API_MARKET = `${API_BASE}/api/market`; // expected endpoint
    const LS_FAV = "zilkara:favs:v1";

    // Binance deeplink (simple + stable)
    // If you later want exact referral URLs, you can adjust here.
    const BINANCE_HOME = "https://www.binance.com/en";
    const BINANCE_REGISTER = `https://www.binance.com/en/register?ref=${encodeURIComponent(AFF_ID)}`;

    // ============================
    // STATE
    // ============================
    const state = {
      assets: [],
      filtered: [],
      favorites: loadFavs(), // Set(symbolLower)
      search: "",
      sort: "score_desc",
      rating: "all",
      vs: "eur",
      limit: 250,
      mode: "all",
      lastFetchOk: true,
      lastFetchMs: 0,
    };

    // ============================
    // DOM
    // ============================
    const $ = (id) => document.getElementById(id);

    const listEl = $("list");
    const searchEl = $("search");
    const sortEl = $("sort");
    const ratingEl = $("rating");
    const vsEl = $("vs");
    const limitEl = $("limit");
    const modeEl = $("mode");

    const assetsCountEl = $("assetsCount");
    const apiStampEl = $("apiStamp");
    const sourceStampEl = $("sourceStamp");
    const miniStatusEl = $("miniStatus");

    const refreshBtn = $("refreshBtn");
    const exportBtn = $("exportBtn");
    const openBinanceEl = $("openBinance");
    const affLineEl = $("affLine");

    // ============================
    // HELPERS
    // ============================
    function loadFavs(){
      try{
        const raw = localStorage.getItem(LS_FAV);
        if(!raw) return new Set();
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return new Set();
        return new Set(arr.map(s => String(s).toLowerCase()));
      }catch(_){
        return new Set();
      }
    }

    function saveFavs(){
      try{
        localStorage.setItem(LS_FAV, JSON.stringify([...state.favorites]));
      }catch(_){}
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function num(v, def=0){
      const n = Number(v);
      return Number.isFinite(n) ? n : def;
    }

    function fmtPrice(value, vs){
      const v = num(value, NaN);
      if(!Number.isFinite(v)) return "—";
      const currency = (vs || "eur").toUpperCase();
      try{
        return new Intl.NumberFormat("fr-FR", { style:"currency", currency, maximumFractionDigits: v >= 1000 ? 0 : (v >= 1 ? 2 : 6) }).format(v);
      }catch(_){
        return `${v}`;
      }
    }

    function fmtPct(value){
      const v = num(value, NaN);
      if(!Number.isFinite(v)) return "—";
      const sign = v > 0 ? "+" : "";
      return `${sign}${v.toFixed(2)}%`;
    }

    function pctClass(value){
      const v = num(value, NaN);
      if(!Number.isFinite(v) || v === 0) return "neu";
      return v > 0 ? "pos" : "neg";
    }

    function fmtBig(n){
      const v = num(n, NaN);
      if(!Number.isFinite(v)) return "—";
      // compact formatting
      const abs = Math.abs(v);
      const units = [
        {k:1e12, s:"T"},
        {k:1e9,  s:"B"},
        {k:1e6,  s:"M"},
        {k:1e3,  s:"K"},
      ];
      for(const u of units){
        if(abs >= u.k) return (v/u.k).toFixed(2).replace(/\.00$/,"") + u.s;
      }
      return String(Math.round(v));
    }

    function badgeClass(r){
      const R = String(r || "").toUpperCase();
      if(R === "STRONG") return "strong";
      if(R === "GOOD") return "good";
      if(R === "WEAK") return "weak";
      return "avoid";
    }

    function buildBinanceTradeUrl(symbol){
      // simple: open Binance register (ref) if user not connected
      // later you can switch to a pair/trade URL if you want
      return BINANCE_REGISTER;
    }

    function buildBinanceAssetUrl(symbol){
      return BINANCE_REGISTER;
    }

    function todayIso(){
      const d = new Date();
      const pad = (x)=> String(x).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`;
    }

    function debounce(fn, wait=180){
      let t;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), wait);
      };
    }

    // ============================
    // API
    // ============================
    async function fetchMarket(){
      const qs = new URLSearchParams({
        vs: state.vs,
        limit: String(state.limit),
      });
      const url = `${API_MARKET}?${qs.toString()}`;

      const t0 = performance.now();
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok){
        throw new Error(`HTTP ${res.status}`);
      }
      const json = await res.json();
      // expected: { assets: [...] } OR array directly
      const assets = Array.isArray(json) ? json : (Array.isArray(json.assets) ? json.assets : (Array.isArray(json.data) ? json.data : []));
      state.lastFetchMs = Math.round(performance.now() - t0);
      return assets;
    }

    // ============================
    // NORMALIZE
    // ============================
    function normalizeAsset(a){
      // accept multiple shapes
      const sym = String(a.symbol || a.sym || "").toUpperCase();
      const symLower = sym.toLowerCase();

      return {
        id: a.id || a.coin_id || a.slug || symLower,
        symbol: sym,
        symbolLower: symLower,
        name: a.name || a.coin_name || a.title || sym,
        rank: num(a.rank ?? a.market_cap_rank, 9999),
        price: num(a.price ?? a.current_price, NaN),
        score: num(a.score, NaN),
        rating: String(a.rating || "").toUpperCase() || "WEAK",
        chg24: num(a.chg_24h_pct ?? a.price_change_percentage_24h, NaN),
        chg7: num(a.chg_7d_pct ?? a.price_change_percentage_7d_in_currency, NaN),
        chg30: num(a.chg_30d_pct ?? a.price_change_percentage_30d_in_currency, NaN),
        marketCap: num(a.market_cap ?? a.mc ?? a.market_cap_value, NaN),
        volume: num(a.total_volume ?? a.volume_24h ?? a.vol, NaN),
      };
    }

    // ============================
    // FILTER + SORT
    // ============================
    function applyFilters(){
      const q = state.search.trim().toLowerCase();
      const wantRating = state.rating;

      let arr = state.assets;

      if(state.mode === "favorites"){
        arr = arr.filter(x => state.favorites.has(x.symbolLower));
      }

      if(q){
        arr = arr.filter(x =>
          x.symbolLower.includes(q) ||
          String(x.name||"").toLowerCase().includes(q) ||
          String(x.rank).includes(q)
        );
      }

      if(wantRating !== "all"){
        arr = arr.filter(x => String(x.rating).toUpperCase() === wantRating);
      }

      // sort
      const s = state.sort;
      const by = (fn) => arr.slice().sort((a,b)=> fn(a,b));

      const safe = (v, fallback=-Infinity) => (Number.isFinite(v) ? v : fallback);

      if(s === "score_desc") arr = by((a,b)=> safe(b.score) - safe(a.score));
      else if(s === "score_asc") arr = by((a,b)=> safe(a.score, Infinity) - safe(b.score, Infinity));
      else if(s === "rank_asc") arr = by((a,b)=> safe(a.rank, Infinity) - safe(b.rank, Infinity));
      else if(s === "rank_desc") arr = by((a,b)=> safe(b.rank) - safe(a.rank));
      else if(s === "price_desc") arr = by((a,b)=> safe(b.price) - safe(a.price));
      else if(s === "price_asc") arr = by((a,b)=> safe(a.price, Infinity) - safe(b.price, Infinity));
      else if(s === "chg24_desc") arr = by((a,b)=> safe(b.chg24) - safe(a.chg24));
      else if(s === "chg24_asc") arr = by((a,b)=> safe(a.chg24, Infinity) - safe(b.chg24, Infinity));

      state.filtered = arr;
    }

    // ============================
    // RENDER
    // ============================
    function render(){
      applyFilters();

      assetsCountEl.textContent = String(state.filtered.length);
      sourceStampEl.textContent = `Source: CoinGecko • VS: ${state.vs.toUpperCase()}`;
      affLineEl.textContent = `Affiliation Binance: ${AFF_ID}`;

      // list
      listEl.innerHTML = "";
      const frag = document.createDocumentFragment();

      for(const a of state.filtered){
        frag.appendChild(renderCard(a));
      }
      listEl.appendChild(frag);

      miniStatusEl.textContent = state.lastFetchOk
        ? `OK • ${state.lastFetchMs}ms`
        : `Erreur API`;
    }

    function renderCard(a){
      const card = document.createElement("div");
      card.className = "card";

      // Top line
      const top = document.createElement("div");
      top.className = "cardTop";

      const left = document.createElement("div");
      left.style.minWidth = "0";

      const title = document.createElement("div");
      title.className = "cardTitle";

      const star = document.createElement("div");
      star.className = "star" + (state.favorites.has(a.symbolLower) ? " on" : "");
      star.title = "Favori";
      star.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 17.3l-6.18 3.25 1.18-6.88L1 7.98l6.91-1 3.09-6.26 3.09 6.26 6.91 1-5 5.69 1.18 6.88L12 17.3z"
                stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
        </svg>
      `;
      star.addEventListener("click", ()=>{
        if(state.favorites.has(a.symbolLower)) state.favorites.delete(a.symbolLower);
        else state.favorites.add(a.symbolLower);
        saveFavs();
        render();
      });

      const sym = document.createElement("div");
      sym.className = "sym";
      sym.textContent = a.symbol || "—";

      const rank = document.createElement("div");
      rank.className = "rank";
      rank.textContent = `#${a.rank ?? "—"}`;

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = a.name || "";

      title.appendChild(star);
      title.appendChild(sym);
      title.appendChild(rank);
      left.appendChild(title);
      left.appendChild(name);

      const badge = document.createElement("div");
      badge.className = `badge ${badgeClass(a.rating)}`;
      badge.textContent = String(a.rating || "WEAK").toUpperCase();

      top.appendChild(left);
      top.appendChild(badge);

      // Metrics boxes
      const metrics = document.createElement("div");
      metrics.className = "metrics";

      const priceBox = document.createElement("div");
      priceBox.className = "box";
      priceBox.innerHTML = `<div class="k">PRICE</div><div class="v">${fmtPrice(a.price, state.vs)}</div>`;

      const scoreBox = document.createElement("div");
      scoreBox.className = "box";
      scoreBox.innerHTML = `<div class="k">SCORE</div><div class="v mono">${Number.isFinite(a.score) ? Math.round(a.score) : "—"}</div>`;

      metrics.appendChild(priceBox);
      metrics.appendChild(scoreBox);

      // Changes
      const changes = document.createElement("div");
      changes.className = "changes";

      const c24 = document.createElement("div");
      c24.className = "chg";
      c24.innerHTML = `<div class="k">24H</div><div class="v ${pctClass(a.chg24)}">${fmtPct(a.chg24)}</div>`;

      const c7 = document.createElement("div");
      c7.className = "chg";
      c7.innerHTML = `<div class="k">7D</div><div class="v ${pctClass(a.chg7)}">${fmtPct(a.chg7)}</div>`;

      const c30 = document.createElement("div");
      c30.className = "chg";
      c30.innerHTML = `<div class="k">30D</div><div class="v ${pctClass(a.chg30)}">${fmtPct(a.chg30)}</div>`;

      changes.appendChild(c24);
      changes.appendChild(c7);
      changes.appendChild(c30);

      // Buttons
      const rowBtns = document.createElement("div");
      rowBtns.className = "rowBtns";

      const trade = document.createElement("a");
      trade.className = "btnRow primary";
      trade.href = buildBinanceTradeUrl(a.symbol);
      trade.target = "_blank";
      trade.rel = "noopener";
      trade.textContent = "Trade";

      const binance = document.createElement("a");
      binance.className = "btnRow";
      binance.href = buildBinanceAssetUrl(a.symbol);
      binance.target = "_blank";
      binance.rel = "noopener";
      binance.textContent = "Binance";

      rowBtns.appendChild(trade);
      rowBtns.appendChild(binance);

      // Assemble
      card.appendChild(top);
      card.appendChild(metrics);
      card.appendChild(changes);
      card.appendChild(rowBtns);

      return card;
    }

    // ============================
    // CSV EXPORT (client-side)
    // ============================
    function exportCsv(){
      const rows = state.filtered;

      const headers = [
        "rank","symbol","name","price","score","rating","chg_24h_pct","chg_7d_pct","chg_30d_pct","market_cap","volume"
      ];

      const esc = (v)=>{
        const s = String(v ?? "");
        if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      };

      const lines = [];
      lines.push(headers.join(","));
      for(const a of rows){
        lines.push([
          a.rank,
          a.symbol,
          a.name,
          Number.isFinite(a.price) ? a.price : "",
          Number.isFinite(a.score) ? a.score : "",
          a.rating,
          Number.isFinite(a.chg24) ? a.chg24 : "",
          Number.isFinite(a.chg7) ? a.chg7 : "",
          Number.isFinite(a.chg30) ? a.chg30 : "",
          Number.isFinite(a.marketCap) ? a.marketCap : "",
          Number.isFinite(a.volume) ? a.volume : "",
        ].map(esc).join(","));
      }

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const filename = `zilkara_${state.vs.toUpperCase()}_${rows.length}_assets_${todayIso()}.csv`;

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(()=> URL.revokeObjectURL(url), 1200);
    }

    // ============================
    // EVENTS
    // ============================
    const onSearch = debounce(()=>{ state.search = searchEl.value; render(); }, 140);

    searchEl.addEventListener("input", onSearch);
    sortEl.addEventListener("change", ()=>{ state.sort = sortEl.value; render(); });
    ratingEl.addEventListener("change", ()=>{ state.rating = ratingEl.value; render(); });

    vsEl.addEventListener("change", async ()=>{
      state.vs = vsEl.value;
      await load();
    });

    limitEl.addEventListener("change", async ()=>{
      state.limit = clamp(Number(limitEl.value)||250, 10, 250);
      await load();
    });

    modeEl.addEventListener("change", ()=>{
      state.mode = modeEl.value;
      render();
    });

    refreshBtn.addEventListener("click", load);
    exportBtn.addEventListener("click", exportCsv);

    openBinanceEl.href = BINANCE_REGISTER;

    // ============================
    // LOAD
    // ============================
    async function load(){
      try{
        miniStatusEl.textContent = "Chargement…";
        const raw = await fetchMarket();

        const assets = raw.map(normalizeAsset).filter(x => x.symbol);
        state.assets = assets;
        state.lastFetchOk = true;

        // stamp
        const now = new Date();
        apiStampEl.textContent = `API ${now.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}`;

        // render
        render();
      }catch(e){
        state.lastFetchOk = false;
        console.error(e);
        miniStatusEl.textContent = "Erreur API";
        // keep previous render, just update stamp
        const now = new Date();
        apiStampEl.textContent = `API erreur`;
      }
    }

    // init
    (function init(){
      // set initial UI values
      sortEl.value = state.sort;
      ratingEl.value = state.rating;
      vsEl.value = state.vs;
      limitEl.value = String(state.limit);
      modeEl.value = state.mode;

      load();
    })();
  </script>
</body>
</html>
